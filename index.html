<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gelbooru Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Pacifico&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #190021 0%, #2d0036 100%);
      color: #fff;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }
    header {
      padding: 1rem;
      background: linear-gradient(90deg, #2d0036 0%, #ff2a68 100%);
      border-bottom: 3px solid #ff2a68;
      box-shadow: 0 2px 16px #ff2a6833;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-family: 'Playfair Display', serif;
      font-size: 1.2em;
    }
    .stats {
      color: #e75480;
      font-size: 1.1em;
      font-family: 'Pacifico', cursive;
      text-shadow: 0 0 8px #e75480bb;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .stats::before {
      content: "üíã";
      font-size: 1.2em;
      vertical-align: middle;
    }
    header input, header button, header select {
      padding: 0.5em;
      font-size: 1em;
      border: none;
      border-radius: 999px;
      margin: 0 0.2em;
    }
    header input {
      background: #1a001d;
      color: #fff;
      border: 1.5px solid #e75480;
      font-family: 'Segoe UI', sans-serif;
      transition: box-shadow 0.2s;
      box-shadow: 0 0 6px #e7548077;
    }
    header input:focus {
      box-shadow: 0 0 18px #ff2a6877;
      outline: none;
    }
    header button, header select {
      background: #e75480;
      color: #fff;
      font-weight: bold;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 0 10px #e7548077;
      border-radius: 999px;
      cursor: pointer;
    }
    header button:hover, header select:hover {
      background: #ff7eb9;
      box-shadow: 0 0 30px #ff2a68cc;
      transform: scale(1.08);
    }
    #toggleTheme {
      background: #111;
      color: #ff7eb9;
      border: 2px solid #e75480;
      box-shadow: 0 0 8px #e75480cc;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    #toggleTheme:hover {
      background: #ff7eb9;
      color: #111;
      box-shadow: 0 0 16px #e75480;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 18px;
      padding: 1.5rem;
    }
    .thumb {
      position: relative;
      overflow: hidden;
      border-radius: 24px;
      cursor: pointer;
      transition: transform 0.25s, box-shadow 0.25s, border 0.2s;
      background: #1e1e1e;
      border: 2.5px solid transparent;
      box-shadow: 0 0 16px #8f5fff66;
      will-change: transform;
    }
    .thumb:hover {
      transform: scale(1.06) rotate(-2deg);
      border: 2.5px solid #e75480;
      box-shadow: 0 0 40px #ff2a6888;
      z-index: 2;
      animation: shake 0.25s;
    }
    @keyframes shake {
      0% { transform: scale(1.06) rotate(-2deg) }
      25% { transform: scale(1.07) rotate(2deg) }
      50% { transform: scale(1.06) rotate(-2deg) }
      75% { transform: scale(1.07) rotate(2deg) }
      100% { transform: scale(1.06) rotate(-2deg) }
    }
    .thumb img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 22px;
      filter: brightness(0.92) contrast(1.05);
      transition: filter 0.2s;
    }
    .thumb:hover img {
      filter: brightness(1.04) blur(1px) contrast(1.15);
    }
    .tags {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(0deg, #e75480cc 0%, #00000000 100%);
      color: #fff;
      font-size: 1.1em;
      padding: 7px;
      box-sizing: border-box;
      border-radius: 0 0 22px 22px;
      letter-spacing: 0.05em;
      font-family: 'Pacifico', cursive;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .tags::before {
      content: "‚ú®";
      color: #ffb3d2;
      margin-right: 0.3em;
    }
    #slideshow {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(29,0,39,0.97);
      backdrop-filter: blur(8px);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0;}
      to { opacity: 1;}
    }
    #slideshow.show { display: flex; }
    #slideImg {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 18px;
      box-shadow: 0 0 36px #e7548077;
      border: 3px solid #ff2a68;
      transition: opacity 0.3s;
    }
    #slideTags {
      color: #ffb3d2;
      margin-top: 1rem;
      max-width: 80vw;
      text-align: center;
      font-size: 1.1em;
      word-wrap: break-word;
      text-shadow: 0 0 8px #e75480bb;
      font-family: 'Pacifico', cursive;
      letter-spacing: 0.05em;
    }
    .slideshow-controls {
      margin-top: 0.8rem;
      display: flex;
      gap: 1rem;
    }
    .slideshow-controls button {
      background: #e75480;
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 999px;
      font-size: 1.5rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 0 12px #e75480bb;
    }
    .slideshow-controls button:hover {
      background: #ff7eb9;
      transform: scale(1.1);
      box-shadow: 0 0 28px #e75480cc;
    }
    .info {
      text-align: center;
      color: #ff7eb9;
      margin: 1.2rem;
      font-size: 16px;
      font-family: 'Playfair Display', serif;
      text-shadow: 0 0 6px #e75480cc;
    }
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 2000; 
      left: 0; top: 0; 
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); 
      align-items: center; 
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: rgba(30,0,50,0.97);
      color: #fff;
      padding: 2rem;
      border-radius: 20px;
      border: 2.5px solid #ff2a68;
      box-shadow: 0 0 32px #e75480bb;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    }
    h2 {
      font-family: 'Playfair Display', serif;
      letter-spacing: 0.08em;
      color: #ff7eb9;
      text-shadow: 0 0 6px #e75480cc;
      margin-top: 0;
    }
    .suggestions {
      position: absolute; 
      background: #333; 
      color: #fff; 
      border-radius: 0 0 5px 5px; 
      z-index: 500; 
      max-height: 160px; 
      overflow: auto; 
      width: 100%; 
      left: 0; 
      top: 100%;
      font-family: 'Segoe UI', sans-serif;
      font-size: 1em;
      box-shadow: 0 3px 12px #e75480aa;
    }
    .suggestion-item { padding: 0.5em; cursor: pointer; }
    .suggestion-item:hover, .suggestion-item.active { background: #ff7eb9; color: #222; }
    @media (max-width:600px) {
      header { flex-direction: column; }
      .thumb img { height: 160px; }
      .modal-content { padding: 1em; }
    }
    /* Footer */
    footer {
      text-align: center;
      color: #ff7eb9;
      font-family: 'Pacifico', cursive;
      font-size: 1.2em;
      margin: 2em 0 1em 0;
      text-shadow: 0 0 8px #e75480;
      user-select: none;
      letter-spacing: 0.03em;
    }
    /* Plugin panel styles */
    #pluginPanel textarea { font-family: monospace; background: #1a001d; color: #ff7eb9; border: 1px solid #e75480; border-radius: 5px; }
    #pluginPanel button { background: #e75480; color: #fff; border: none; border-radius: 5px; padding: 0.3em 1em; cursor: pointer;}
    #pluginPanel button:hover { background: #ff7eb9; color: #222; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; flex:1; position:relative;">
      <input id="searchInput" placeholder="Search for your next waifu‚Ä¶" aria-label="Search tags" autocomplete="off" aria-autocomplete="list"/>
      <div id="suggestions" class="suggestions" role="listbox" aria-label="Suggested tags"></div>
      <button id="searchBtn" aria-label="Search images by tags">üîé Search</button>
      <select id="sortSelect" aria-label="Sort images">
        <option value="date">Sort by Date</option>
        <option value="popular">Sort by Popularity</option>
        <option value="random">Random</option>
      </select>
      <button id="favoritesBtn" aria-label="Show favorites">‚ù§Ô∏è Favorites</button>
      <button id="clearFavs" aria-label="Clear all favorites">üóëÔ∏è Clear</button>
      <button id="toggleTheme" aria-label="Toggle dark and light mode">üåô/‚òÄÔ∏è</button>
    </div>
    <div class="stats" id="viewStats" aria-live="polite">Waifus seen: 0</div>
  </header>
  <main>
    <div class="gallery" id="gallery" role="list" aria-label="Image gallery"></div>
  </main>
  <div class="info">Uses cookies for favorites and stats. Infinite scroll enabled.</div>
  <div id="slideshow" role="dialog" aria-modal="true" aria-label="Image slideshow" tabindex="-1">
    <img id="slideImg" alt="Slideshow image"/>
    <div id="slideTags"></div>
    <div class="slideshow-controls">
      <button id="prevSlide" aria-label="Previous image">‚è™</button>
      <button id="nextSlide" aria-label="Next image">‚è©</button>
      <button id="favoriteSlide" aria-label="Favorite this image">üíñ</button>
      <button id="closeSlideshow" aria-label="Close slideshow">‚ùå</button>
    </div>
  </div>
  <div id="favoritesModal" class="modal" role="dialog" aria-modal="true" aria-label="Favorites">
    <div class="modal-content">
      <h2>Favorites</h2>
      <div id="favoritesGallery" class="gallery"></div>
      <button id="closeFavs" aria-label="Close favorites modal">Close</button>
    </div>
  </div>
  <!-- Optional Easter Egg: Press ‚Üë ‚Üë ‚Üì ‚Üì ‚Üê ‚Üí ‚Üê ‚Üí B A for a surprise! -->
  <footer>
    Made with ‚ù§Ô∏è for waifu lovers &mdash; <span style="color:#fff3;">SLIGHTLY CHILLED WATER</span>
  </footer>

  <!-- Plugin Panel -->
  <div id="pluginPanel" style="position:fixed;bottom:1em;right:1em;z-index:4000;background:#222;color:#ff7eb9;padding:1em;border-radius:12px;box-shadow:0 2px 18px #ff2a6890;">
    <strong>Plugins</strong><br>
    <textarea id="pluginScript" rows="4" style="width:200px;"></textarea><br>
    <button id="runPlugin" style="margin-top:0.5em;">Run</button>
  </div>
  
  <script defer>
    // Theme toggle and cookies
    const toggleTheme = document.getElementById('toggleTheme');
    toggleTheme.addEventListener('click', () => {
      document.body.classList.toggle('light');
      saveCookie('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });
    function saveCookie(k, v) { document.cookie = `${k}=${encodeURIComponent(v)};path=/;max-age=31536000`; }
    function loadCookie(k) {
      const re = new RegExp('(^| )'+k+'=([^;]+)');
      const m = document.cookie.match(re);
      return m ? decodeURIComponent(m[2]) : null;
    }
    if (loadCookie('theme') === 'light') document.body.classList.add('light');

    let page = 0, seen = 0, currentTags = '', images = [], currentSlide = 0, isLoading = false, currentSort='date';
    const batchSize = 20;
    const gallery = document.getElementById('gallery'),
          slideImg = document.getElementById('slideImg'),
          slideTags = document.getElementById('slideTags'),
          stats = document.getElementById('viewStats'),
          slideshow = document.getElementById('slideshow'),
          sortSelect = document.getElementById('sortSelect'),
          suggestionsBox = document.getElementById('suggestions'),
          favoritesModal = document.getElementById('favoritesModal'),
          favoritesGallery = document.getElementById('favoritesGallery');

    // Restore last search term if present
    const lastSearch = localStorage.getItem('lastSearch');
    if (lastSearch) {
      document.getElementById('searchInput').value = lastSearch;
      currentTags = lastSearch;
    }

    function updateStats() {
      stats.textContent = `Waifus seen: ${seen}`;
    }

    async function fetchTagsSuggest(query) {
      if (!query) return [];
      return ['catgirl', 'doggirl', 'maid', 'bunny', 'foxgirl', 'elf'].filter(t => t.includes(query.toLowerCase()));
    }

    let suggestActive = -1;
    document.getElementById('searchInput').addEventListener('input', async function(e) {
      const value = this.value.trim();
      const suggestions = await fetchTagsSuggest(value);
      suggestionsBox.innerHTML = '';
      suggestActive = -1;
      if (suggestions.length && value) {
        suggestionsBox.style.display = 'block';
        suggestions.forEach((s, i) => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = s;
          div.setAttribute('role', 'option');
          div.addEventListener('mousedown', function() {
            document.getElementById('searchInput').value = s;
            suggestionsBox.innerHTML = '';
          });
          suggestionsBox.appendChild(div);
        });
      } else {
        suggestionsBox.style.display = 'none';
      }
    });
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
      const items = suggestionsBox.querySelectorAll('.suggestion-item');
      if (!items.length) return;
      if (e.key === 'ArrowDown') {
        suggestActive = (suggestActive + 1) % items.length;
      } else if (e.key === 'ArrowUp') {
        suggestActive = (suggestActive - 1 + items.length) % items.length;
      } else if (e.key === 'Enter') {
        if (suggestActive >= 0) {
          e.preventDefault();
          items[suggestActive].dispatchEvent(new Event('mousedown'));
        }
      }
      items.forEach((item, idx) => item.classList.toggle('active', idx === suggestActive));
    });
    document.addEventListener('click', () => suggestionsBox.innerHTML = '');

    sortSelect.addEventListener('change', () => {
      currentSort = sortSelect.value;
      page = 0; fetchImages(currentTags, false);
    });

    async function fetchImages(tags = currentTags, append = false) {
      if (isLoading) return;
      isLoading = true;
      try {
        const cacheBust = `&_=${Date.now()}`;
        const res = await fetch(`/api/images?tags=${encodeURIComponent(tags)}&page=${page}&limit=${batchSize}&sort=${currentSort}${cacheBust}`);
        if (!res.ok) throw new Error('Fetch failure: '+res.status);
        const data = await res.json();
        const posts = Array.isArray(data.post) ? data.post : [];
        if (!append) images = [];
        images = images.concat(posts);
        renderImages(posts, append);
        if (!append) window.addEventListener('scroll', onScroll, { passive: true });
        if (posts.length === 0) window.removeEventListener('scroll', onScroll);
      } catch(e) {
        showModal('Error', 'Error loading images. Please try again.');
      } finally {
        isLoading = false;
      }
    }

    // ---- Make tags clickable ----
    function renderTags(tagString, tagDiv) {
      const tagArr = tagString.split(' ').slice(0, 4);
      tagDiv.innerHTML = '';
      tagArr.forEach(tag => {
        const tagSpan = document.createElement('span');
        tagSpan.textContent = tag;
        tagSpan.style.cursor = 'pointer';
        tagSpan.style.textDecoration = 'underline';
        tagSpan.style.marginRight = '0.3em';
        tagSpan.addEventListener('click', e => {
          e.stopPropagation();
          document.getElementById('searchInput').value = tag;
          localStorage.setItem('lastSearch', tag);
          currentTags = tag;
          page = 0;
          fetchImages(tag, false);
        });
        tagDiv.appendChild(tagSpan);
      });
    }

    function renderImages(posts, append) {
      const frag = document.createDocumentFragment();
      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'thumb'; div.tabIndex=0;
        div.role = 'listitem'; div.setAttribute('aria-label', `Tags: ${post.tags}`);
        const img = document.createElement('img');
        img.src = post.preview_url || post.sample_url || '';
        img.alt = post.tags || 'Image';
        img.loading = "lazy";
        const tagDiv = document.createElement('div');
        tagDiv.className = 'tags';
        renderTags(post.tags, tagDiv); // clickable tags
        div.append(img, tagDiv);
        frag.appendChild(div);
      });
      if (!append) gallery.innerHTML = '';
      gallery.appendChild(frag);
      seen += posts.length;
      updateStats();
    }

    gallery.addEventListener('click', e => {
      const thumb = e.target.closest('.thumb');
      if (thumb) showSlide(Array.prototype.indexOf.call(gallery.children, thumb));
    });
    gallery.addEventListener('keydown', e => {
      if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('thumb')) {
        e.preventDefault();
        showSlide(Array.prototype.indexOf.call(gallery.children, e.target));
      }
    });

    function showSlide(i) {
      const p = images[i];
      if (!p) return;
      currentSlide = i;
      slideImg.src = p.file_url || p.sample_url || p.preview_url || '';
      slideImg.alt = 'Tags: '+p.tags;
      slideTags.innerHTML = '';
      renderTags(p.tags, slideTags);
      slideshow.classList.add('show');
      slideshow.focus();
      slideImg.focus();
    }
    const closeSlide = () => slideshow.classList.remove('show');

    function toggleFavorite(i) {
      const p = images[i];
      if (!p) return;
      let favs = [];
      try { favs = JSON.parse(loadCookie('favorites')||'[]'); } catch{}
      const idx = favs.findIndex(a=>a.id===p.id);
      if (idx>=0) { favs.splice(idx,1); showModal('Favorites', 'Removed from favorites ü•∫'); }
      else { favs.push(p); showModal('Favorites', 'Added to your harem üíñ'); }
      saveCookie('favorites', JSON.stringify(favs));
      updateFavoritesGallery();
    }

    function showModal(title, content) {
      favoritesModal.querySelector('h2').textContent = title;
      favoritesGallery.innerHTML = `<div style="padding:1em">${content}</div>`;
      favoritesModal.classList.add('show');
      document.getElementById('closeFavs').focus();
    }

    function showFavorites() {
      updateFavoritesGallery();
      favoritesModal.classList.add('show');
      document.getElementById('closeFavs').focus();
    }

    function updateFavoritesGallery() {
      let favs=[];
      try { favs=JSON.parse(loadCookie('favorites')||'[]'); } catch{}
      if(!favs.length){ favoritesGallery.innerHTML='<div style="padding:1em">Your harem is empty ü•∫ Add some waifus!</div>'; return; }
      favoritesGallery.innerHTML='';
      favs.forEach((post, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb'; div.tabIndex=0;
        div.role = 'listitem';
        const img = document.createElement('img');
        img.src = post.preview_url || post.sample_url || '';
        img.alt = post.tags || 'Image';
        img.loading = "lazy";
        div.append(img);
        const tagDiv = document.createElement('div');
        tagDiv.className = 'tags';
        renderTags(post.tags, tagDiv);
        div.append(tagDiv);
        div.addEventListener('click',()=>showFavSlide(idx));
        favoritesGallery.appendChild(div);
      });
      function showFavSlide(i) {
        images = favs;
        showSlide(i);
      }
    }

    document.getElementById('closeFavs').addEventListener('click',()=>favoritesModal.classList.remove('show'));
    document.getElementById('favoritesModal').addEventListener('click',e=>{
      if(e.target===favoritesModal)favoritesModal.classList.remove('show');
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      currentTags = document.getElementById('searchInput').value.trim();
      localStorage.setItem('lastSearch', currentTags); // save search
      page = 0; fetchImages(currentTags,false);
    });
    document.getElementById('favoritesBtn').addEventListener('click', showFavorites);
    document.getElementById('clearFavs').addEventListener('click', () => {
      saveCookie('favorites','[]'); showModal('Favorites','Cleared all favorites üóëÔ∏è');
      updateFavoritesGallery();
    });
    document.getElementById('prevSlide').addEventListener('click', () => showSlide((currentSlide-1+images.length)%images.length));
    document.getElementById('nextSlide').addEventListener('click', () => showSlide((currentSlide+1)%images.length));
    document.getElementById('favoriteSlide').addEventListener('click', () => toggleFavorite(currentSlide));
    document.getElementById('closeSlideshow').addEventListener('click', closeSlide);

    window.addEventListener('keydown', e => {
      if (favoritesModal.classList.contains('show') && e.key==='Escape') favoritesModal.classList.remove('show');
      if (!slideshow.classList.contains('show')) return;
      if (e.key==='Escape') return closeSlide();
      if (e.key==='ArrowRight') return showSlide((currentSlide+1)%images.length);
      if (e.key==='ArrowLeft') return showSlide((currentSlide-1+images.length)%images.length);
      if (e.key.toLowerCase()==='f') return toggleFavorite(currentSlide);
    });

    function onScroll() {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        page++;
        fetchImages(currentTags,true);
      }
    }

    window.addEventListener('load', () => {
      const last = parseInt(loadCookie('waifus_seen')||'0',10);
      seen = isNaN(last)?0:last;
      updateStats();
      fetchImages();
    });

    // Swipe/slide for mobile
    let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0;
    let swipeThreshold = 50;
    slideImg.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
    }, { passive: true });
    slideImg.addEventListener('touchmove', function(e) {
      if (e.touches.length === 1) {
        touchEndX = e.touches[0].clientX;
        touchEndY = e.touches[0].clientY;
      }
    }, { passive: true });
    slideImg.addEventListener('touchend', function(e) {
      let dx = touchEndX - touchStartX;
      let dy = touchEndY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > swipeThreshold) {
        if (dx < 0) {
          showSlide((currentSlide + 1) % images.length);
        } else {
          showSlide((currentSlide - 1 + images.length) % images.length);
        }
      }
      touchStartX = touchEndX = touchStartY = touchEndY = 0;
    }, { passive: true });

    // Easter Egg: Konami code for a surprise
    const konami = [38,38,40,40,37,39,37,39,66,65];
    let konamiIndex = 0;
    window.addEventListener('keydown', function(e) {
      if (e.keyCode === konami[konamiIndex]) {
        konamiIndex++;
        if (konamiIndex === konami.length) {
          alert('‚ú® You unlocked Ultra Waifu Mode! (Add your own effect here!)');
          konamiIndex = 0;
        }
      } else {
        konamiIndex = 0;
      }
    });

    // ---- Plugin Panel ----
    document.getElementById('runPlugin').addEventListener('click', function() {
      const code = document.getElementById('pluginScript').value;
      try {
        new Function(code)();
        alert('Plugin executed!');
      } catch (e) {
        alert('Plugin error: ' + e.message);
      }
    });
  </script>
</body>
</html>
