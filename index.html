<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gelbooru Viewer</title>
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; background:#111; color:#fff; }
    header { padding:1rem; background:#222; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem; }
    header input, header button { padding:0.5em; font-size:1em; border:none; border-radius:4px; }
    header input { background:#333; color:#fff; flex:1 1 250px; }
    header button { background:#444; color:#fff; cursor:pointer; }
    header button:hover { background:#666; }
    .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; padding:1rem; }
    .thumb { position:relative; overflow:hidden; border-radius:10px; cursor:pointer; transition:transform 0.3s; background:#1e1e1e; }
    .thumb:hover { transform:scale(1.03); }
    .thumb img { width:100%; height:220px; object-fit:cover; user-select:none; }
    .tags { position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.6); color:#ccc; font-size:12px; padding:6px; box-sizing:border-box; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #slideshow { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.98); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:1000; padding:1rem; box-sizing:border-box; }
    #slideshow.show { display:flex; }
    #slideImg { max-width:90vw; max-height:85vh; border-radius:12px; box-shadow:0 0 30px #000; transition:opacity 0.4s ease; user-select:none; }
    #slideTags { color:#ccc; margin-top:0.7rem; max-width:80vw; text-align:center; word-wrap:break-word; user-select:text; }
    .slideshow-controls { margin-top:0.8rem; display:flex; gap:0.5rem; }
    .slideshow-controls button { background:#444; color:#fff; border:none; padding:0.5rem 1rem; border-radius:8px; font-size:1.2rem; cursor:pointer; transition:background-color 0.3s; }
    .slideshow-controls button:hover { background:#666; }
    .info, .stats { text-align:center; color:#aaa; margin:1rem; font-size:14px; }
    @media (max-width:600px) {
      header { flex-direction:column; }
      .thumb img { height:160px; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; flex:1;">
      <input id="searchInput" placeholder="Search tags…" aria-label="Search tags"/>
      <button id="searchBtn">Search</button>
      <button id="favoritesBtn">Favorites</button>
      <button id="clearFavs">Clear Favorites</button>
    </div>
    <div class="stats" id="viewStats">Waifus seen: 0</div>
  </header>
  <main><div class="gallery" id="gallery" role="list" aria-label="Image gallery"></div></main>
  <div class="info">Uses cookies for favorites and stats. Infinite scroll enabled.</div>
  <div id="slideshow" role="dialog" aria-modal="true" aria-label="Image slideshow">
    <img id="slideImg" alt="Slideshow image"/>
    <div id="slideTags"></div>
    <div class="slideshow-controls">
      <button id="prevSlide">⏪</button>
      <button id="nextSlide">⏩</button>
      <button id="favoriteSlide">❤️</button>
      <button id="closeSlideshow">❌</button>
    </div>
  </div>

  <script>
    // No eval(), no new Function(), no string-based timers
    let page = 0, seen = 0, currentTags = '', images = [], currentSlide = 0, isLoading = false;
    const batchSize = 20;
    const gallery = document.getElementById('gallery'),
          slideImg = document.getElementById('slideImg'),
          slideTags = document.getElementById('slideTags'),
          stats = document.getElementById('viewStats'),
          slideshow = document.getElementById('slideshow');

    const saveCookie = (k, v) => document.cookie = `${k}=${encodeURIComponent(v)};path=/;max-age=31536000`;
    const loadCookie = k => {
      const re = new RegExp('(^| )'+k+'=([^;]+)');
      const m = document.cookie.match(re);
      return m ? decodeURIComponent(m[2]) : null;
    };

    const updateStats = () => {
      stats.textContent = `Waifus seen: ${seen}`;
      saveCookie('waifus_seen', seen);
    };

    async function fetchImages(tags = currentTags, append = false) {
      if (isLoading) return;
      isLoading = true;
      try {
        const res = await fetch(`/api/images?tags=${encodeURIComponent(tags)}&page=${page}&limit=${batchSize}`);
        if (!res.ok) throw new Error('Fetch failure: '+res.status);
        const data = await res.json();
        const posts = Array.isArray(data.post) ? data.post : [];
        if (!append) images = [];
        images = images.concat(posts);
        renderImages(posts, append);
        if (!append) window.addEventListener('scroll', onScroll);
        if (posts.length === 0) window.removeEventListener('scroll', onScroll);
      } catch(e) {
        console.error(e);
        alert('Error loading images');
      } finally {
        isLoading = false;
      }
    }

    function renderImages(posts, append) {
      if (!append) gallery.innerHTML = '';
      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'thumb'; div.tabIndex=0;
        div.role = 'listitem'; div.setAttribute('aria-label', `Tags: ${post.tags}`);
        const img = document.createElement('img');
        img.src = post.preview_url || post.sample_url || '';
        img.alt = post.tags || 'Image';
        const tagDiv = document.createElement('div');
        tagDiv.className = 'tags';
        tagDiv.textContent = post.tags.split(' ').slice(0,4).join(', ');
        div.append(img, tagDiv);
        div.addEventListener('click', () => showSlide(images.indexOf(post)));
        div.addEventListener('keydown', e => { if (['Enter',' '].includes(e.key)) { e.preventDefault(); showSlide(images.indexOf(post)) } });
        gallery.appendChild(div);
      });
      seen += posts.length;
      updateStats();
    }

    function showSlide(i) {
      const p = images[i];
      if (!p) return;
      currentSlide = i;
      slideImg.src = p.file_url || p.sample_url || p.preview_url || '';
      slideImg.alt = 'Tags: '+p.tags;
      slideTags.textContent = p.tags;
      slideshow.classList.add('show');
      slideshow.focus();
    }
    const closeSlide = () => slideshow.classList.remove('show');

    function toggleFavorite(i) {
      const p = images[i];
      if (!p) return;
      let favs = [];
      try { favs = JSON.parse(loadCookie('favorites')||'[]'); } catch{}
      const idx = favs.findIndex(a=>a.id===p.id);
      if (idx>=0) { favs.splice(idx,1); alert('Removed'); }
      else { favs.push(p); alert('Added'); }
      saveCookie('favorites', JSON.stringify(favs));
    }

    function showFavorites() {
      let favs=[];
      try { favs=JSON.parse(loadCookie('favorites')||'[]'); } catch{}
      if(!favs.length){ alert('No favorites'); return; }
      images=favs; renderImages(favs,false);
      window.removeEventListener('scroll', onScroll);
    }

    document.getElementById('searchBtn').addEventListener('click', () => {
      currentTags = document.getElementById('searchInput').value.trim();
      page = 0; fetchImages(currentTags,false);
    });
    document.getElementById('favoritesBtn').addEventListener('click', showFavorites);
    document.getElementById('clearFavs').addEventListener('click', () => {
      saveCookie('favorites','[]'); alert('Cleared'); 
    });
    document.getElementById('prevSlide').addEventListener('click', () => showSlide((currentSlide-1+images.length)%images.length));
    document.getElementById('nextSlide').addEventListener('click', () => showSlide((currentSlide+1)%images.length));
    document.getElementById('favoriteSlide').addEventListener('click', () => toggleFavorite(currentSlide));
    document.getElementById('closeSlideshow').addEventListener('click', closeSlide);
    window.addEventListener('keydown', e => {
      if (!slideshow.classList.contains('show')) return;
      if (e.key==='Escape') return closeSlide();
      if (e.key==='ArrowRight') return showSlide((currentSlide+1)%images.length);
      if (e.key==='ArrowLeft') return showSlide((currentSlide-1+images.length)%images.length);
      if (e.key.toLowerCase()==='f') return toggleFavorite(currentSlide);
    });

    function onScroll() {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        page++;
        fetchImages(currentTags,true);
      }
    }

    window.addEventListener('load', () => {
      const last = parseInt(loadCookie('waifus_seen')||'0',10);
      seen = isNaN(last)?0:last;
      updateStats();
      fetchImages();
    });
  </script>
</body>
</html>
